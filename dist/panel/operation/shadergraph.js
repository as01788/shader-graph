"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const base_1 = require("./base");
const utils_1 = require("./utils");
const nodes_1 = require("./nodes");
const MasterNode_1 = __importDefault(require("./nodes/master/MasterNode"));
const SubGraphNode_1 = __importDefault(require("./nodes/subgraph/SubGraphNode"));
const fs_1 = __importDefault(require("fs"));
const PropertyNode_1 = __importDefault(require("./nodes/input/PropertyNode"));
class ShaderGraph {
    static searchNodes(graphPath) {
        let contentStr = fs_1.default.readFileSync(graphPath, 'utf-8'); //读取文件
        let content = utils_1.getJsonObject(contentStr); //转成json对象
        if (!content)
            return;
        let properties = content.m_SerializedProperties.map(d => new base_1.ShaderPropery(d)); //找到所有属性
        let nodeMap = new Map;
        let propertyNodeMap = new Map;
        let nodes = content.m_SerializableNodes.map(d => {
            let node = nodes_1.createNode(d);
            if (node instanceof PropertyNode_1.default) {
                node.searchProperties(properties);
                let propertyNode = propertyNodeMap.get(node.property);
                if (propertyNode) {
                    nodeMap.set(node.uuid, propertyNode);
                    return propertyNode;
                }
                propertyNodeMap.set(node.property, node);
            }
            nodeMap.set(node.uuid, node);
            return node;
        });
        let edges = content.m_SerializableEdges.map(d => {
            return new base_1.ShaderEdge(d);
        });
        for (let i = 0; i < edges.length; i++) {
            let edge = edges[i];
            let inputSlot = edge.input;
            let outputSlot = edge.output;
            let inputNode = nodeMap.get(inputSlot.nodeUuid);
            let outputNode = nodeMap.get(outputSlot.nodeUuid);
            if (outputNode instanceof SubGraphNode_1.default) {
                outputNode = outputNode.excahngeSubGraphOutNode(outputSlot);
            }
            if (!inputNode) {
                console.warn(`Can not find input [${inputSlot.nodeUuid}] for edge.`);
                continue;
            }
            if (!outputNode) {
                console.warn(`Can not find input [${outputSlot.nodeUuid}] for edge.`);
                continue;
            }
            inputNode.addDependency(outputNode);
            outputNode.setPriority(inputNode.priority + 1);
            let inputNodeSlot = inputNode.slotsMap.get(inputSlot.id);
            let outputNodeSlot = outputNode.slotsMap.get(outputSlot.id);
            if (inputNodeSlot && outputNodeSlot) {
                inputNodeSlot.connectSlots.push(outputNodeSlot);
                outputNodeSlot.connectSlots.push(inputNodeSlot);
            }
        }
        nodes.sort((a, b) => b.priority - a.priority);
        nodes.forEach(node => {
            if (node instanceof SubGraphNode_1.default) {
                node.exchangeSubGraphInputNodes();
            }
            node.calcConcretePrecision();
        });
        this.allNodes.push(nodes);
        return {
            properties,
            nodeMap,
            nodes,
            edges
        };
    }
    static decode(path) {
        base_1.resetGlobalShaderSlotID(); //重置全局材质id
        this.allNodes.length = 0;
        let res = this.searchNodes(path); //拿到所有shadergraph文件
        if (!res) {
            return;
        }
        let { properties, nodeMap, nodes, edges } = res;
        let masterNode = nodes.find(n => n instanceof MasterNode_1.default);
        if (!masterNode) {
            console.error('Can not find master node.');
            return;
        }
        masterNode.properties = properties;
        this.allNodes.forEach(nodes => {
            nodes.forEach(node => {
                node.beforeGenreateCode();
            });
        });
        let code = masterNode.generateCode();
        return code;
    }
}
exports.default = ShaderGraph;
ShaderGraph.subgraphPath = '';
ShaderGraph.allNodes = [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZGVyZ3JhcGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zb3VyY2UvcGFuZWwvb3BlcmF0aW9uL3NoYWRlcmdyYXBoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsaUNBQXdGO0FBQ3hGLG1DQUF3QztBQUN4QyxtQ0FBcUM7QUFDckMsMkVBQW1EO0FBQ25ELGlGQUF5RDtBQUV6RCw0Q0FBbUI7QUFDbkIsOEVBQXNEO0FBRXRELE1BQXFCLFdBQVc7SUFLNUIsTUFBTSxDQUFDLFdBQVcsQ0FBRSxTQUFpQjtRQUNqQyxJQUFJLFVBQVUsR0FBRyxZQUFFLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFBLE1BQU07UUFDM0QsSUFBSSxPQUFPLEdBQUcscUJBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFBLFVBQVU7UUFDbEQsSUFBSSxDQUFDLE9BQU87WUFBRSxPQUFPO1FBRXJCLElBQUksVUFBVSxHQUFvQixPQUFPLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxvQkFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxRQUFRO1FBQ3hHLElBQUksT0FBTyxHQUE0QixJQUFJLEdBQUcsQ0FBQztRQUUvQyxJQUFJLGVBQWUsR0FBcUMsSUFBSSxHQUFHLENBQUM7UUFFaEUsSUFBSSxLQUFLLEdBQWlCLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDMUQsSUFBSSxJQUFJLEdBQUcsa0JBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUV6QixJQUFJLElBQUksWUFBWSxzQkFBWSxFQUFFO2dCQUM5QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBRWxDLElBQUksWUFBWSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVMsQ0FBQyxDQUFDO2dC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ck5vZGUsIFNoYWRlckVkZ2UsIHJlc2V0R2xvYmFsU2hhZGVyU2xvdElEIH0gZnJvbSBcIi4vYmFzZVwiO1xyXG5pbXBvcnQgeyBnZXRKc29uT2JqZWN0IH0gZnJvbSBcIi4vdXRpbHNcIjtcclxuaW1wb3J0IHsgY3JlYXRlTm9kZSB9IGZyb20gXCIuL25vZGVzXCI7XHJcbmltcG9ydCBNYXN0ZXJOb2RlIGZyb20gXCIuL25vZGVzL21hc3Rlci9NYXN0ZXJOb2RlXCI7XHJcbmltcG9ydCBTdWJHcmFwaE5vZGUgZnJvbSBcIi4vbm9kZXMvc3ViZ3JhcGgvU3ViR3JhcGhOb2RlXCI7XHJcblxyXG5pbXBvcnQgZnMgZnJvbSAnZnMnXHJcbmltcG9ydCBQcm9wZXJ0eU5vZGUgZnJvbSBcIi4vbm9kZXMvaW5wdXQvUHJvcGVydHlOb2RlXCI7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTaGFkZXJHcmFwaCB7XHJcbiAgICBzdGF0aWMgc3ViZ3JhcGhQYXRoID0gJydcclxuXHJcbiAgICBzdGF0aWMgYWxsTm9kZXM6IFNoYWRlck5vZGVbXVtdID0gW107XHJcblxyXG4gICAgc3RhdGljIHNlYXJjaE5vZGVzIChncmFwaFBhdGg6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBjb250ZW50U3RyID0gZnMucmVhZEZpbGVTeW5jKGdyYXBoUGF0aCwgJ3V0Zi04Jyk7Ly/or7vlj5bmlofku7ZcclxuICAgICAgICBsZXQgY29udGVudCA9IGdldEpzb25PYmplY3QoY29udGVudFN0cik7Ly/ovazmiJBqc29u5a+56LGhXHJcbiAgICAgICAgaWYgKCFjb250ZW50KSByZXR1cm47XHJcblxyXG4gICAgICAgIGxldCBwcm9wZXJ0aWVzOiBTaGFkZXJQcm9wZXJ5W10gPSBjb250ZW50Lm1fU2VyaWFsaXplZFByb3BlcnRpZXMubWFwKGQgPT4gbmV3IFNoYWRlclByb3BlcnkoZCkpOy8v5om+5Yiw5omA5pyJ5bGe5oCnXHJcbiAgICAgICAgbGV0IG5vZGVNYXA6IE1hcDxzdHJpbmcsIFNoYWRlck5vZGU+ID0gbmV3IE1hcDtcclxuXHJcbiAgICAgICAgbGV0IHByb3BlcnR5Tm9kZU1hcDogTWFwPFNoYWRlclByb3BlcnksIFByb3BlcnR5Tm9kZT4gPSBuZXcgTWFwO1xyXG5cclxuICAgICAgICBsZXQgbm9kZXM6IFNoYWRlck5vZGVbXSA9IGNvbnRlbnQubV9TZXJpYWxpemFibGVOb2Rlcy5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIGxldCBub2RlID0gY3JlYXRlTm9kZShkKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChub2RlIGluc3RhbmNlb2YgUHJvcGVydHlOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlLnNlYXJjaFByb3BlcnRpZXMocHJvcGVydGllcyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGxldCBwcm9wZXJ0eU5vZGUgPSBwcm9wZXJ0eU5vZGVNYXAuZ2V0KG5vZGUucHJvcGVydHkhKTtcclxuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eU5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBub2RlTWFwLnNldChub2RlLnV1aWQsIHByb3BlcnR5Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5Tm9kZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5vZGVNYXAuc2V0KG5vZGUucHJvcGVydHkhLCBub2RlKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG5vZGVNYXAuc2V0KG5vZGUudXVpZCwgbm9kZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBub2RlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgZWRnZXM6IFNoYWRlckVkZ2VbXSA9IGNvbnRlbnQubV9TZXJpYWxpemFibGVFZGdlcy5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgU2hhZGVyRWRnZShkKVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWRnZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGV0IGVkZ2UgPSBlZGdlc1tpXTtcclxuICAgICAgICAgICAgbGV0IGlucHV0U2xvdCA9IGVkZ2UuaW5wdXQ7XHJcbiAgICAgICAgICAgIGxldCBvdXRwdXRTbG90ID0gZWRnZS5vdXRwdXQ7XHJcblxyXG4gICAgICAgICAgICBsZXQgaW5wdXROb2RlID0gbm9kZU1hcC5nZXQoaW5wdXRTbG90Lm5vZGVVdWlkKTtcclxuICAgICAgICAgICAgbGV0IG91dHB1dE5vZGUgPSBub2RlTWFwLmdldChvdXRwdXRTbG90Lm5vZGVVdWlkKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChvdXRwdXROb2RlIGluc3RhbmNlb2YgU3ViR3JhcGhOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBvdXRwdXROb2RlID0gb3V0cHV0Tm9kZS5leGNhaG5nZVN1YkdyYXBoT3V0Tm9kZShvdXRwdXRTbG90KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFpbnB1dE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQ2FuIG5vdCBmaW5kIGlucHV0IFske2lucHV0U2xvdC5ub2RlVXVpZH1dIGZvciBlZGdlLmApXHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIW91dHB1dE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgQ2FuIG5vdCBmaW5kIGlucHV0IFske291dHB1dFNsb3Qubm9kZVV1aWR9XSBmb3IgZWRnZS5gKVxyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlucHV0Tm9kZS5hZGREZXBlbmRlbmN5KG91dHB1dE5vZGUpO1xyXG4gICAgICAgICAgICBvdXRwdXROb2RlLnNldFByaW9yaXR5KGlucHV0Tm9kZS5wcmlvcml0eSArIDEpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGlucHV0Tm9kZVNsb3QgPSBpbnB1dE5vZGUuc2xvdHNNYXAuZ2V0KGlucHV0U2xvdC5pZCk7XHJcbiAgICAgICAgICAgIGxldCBvdXRwdXROb2RlU2xvdCA9IG91dHB1dE5vZGUuc2xvdHNNYXAuZ2V0KG91dHB1dFNsb3QuaWQpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGlucHV0Tm9kZVNsb3QgJiYgb3V0cHV0Tm9kZVNsb3QpIHtcclxuICAgICAgICAgICAgICAgIGlucHV0Tm9kZVNsb3QuY29ubmVjdFNsb3RzLnB1c2gob3V0cHV0Tm9kZVNsb3QpO1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0Tm9kZVNsb3QuY29ubmVjdFNsb3RzLnB1c2goaW5wdXROb2RlU2xvdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5vZGVzLnNvcnQoKGEsIGIpID0+IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5KTtcclxuXHJcbiAgICAgICAgbm9kZXMuZm9yRWFjaChub2RlID0+IHtcclxuICAgICAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBTdWJHcmFwaE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIG5vZGUuZXhjaGFuZ2VTdWJHcmFwaElucHV0Tm9kZXMoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbm9kZS5jYWxjQ29uY3JldGVQcmVjaXNpb24oKTtcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICB0aGlzLmFsbE5vZGVzLnB1c2gobm9kZXMpO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwcm9wZXJ0aWVzLFxyXG4gICAgICAgICAgICBub2RlTWFwLFxyXG4gICAgICAgICAgICBub2RlcyxcclxuICAgICAgICAgICAgZWRnZXNcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGRlY29kZSAocGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVzZXRHbG9iYWxTaGFkZXJTbG90SUQoKTsvL+mHjee9ruWFqOWxgOadkOi0qGlkXHJcblxyXG4gICAgICAgIHRoaXMuYWxsTm9kZXMubGVuZ3RoID0gMDtcclxuXHJcbiAgICAgICAgbGV0IHJlcyA9IHRoaXMuc2VhcmNoTm9kZXMocGF0aCk7Ly/mi7/liLDmiYDmnIlzaGFkZXJncmFwaOaWh+S7tlxyXG4gICAgICAgIGlmICghcmVzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB7IHByb3BlcnRpZXMsIG5vZGVNYXAsIG5vZGVzLCBlZGdlcyB9ID0gcmVzO1xyXG5cclxuICAgICAgICBsZXQgbWFzdGVyTm9kZSA9IG5vZGVzLmZpbmQobiA9PiBuIGluc3RhbmNlb2YgTWFzdGVyTm9kZSk7XHJcbiAgICAgICAgaWYgKCFtYXN0ZXJOb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NhbiBub3QgZmluZCBtYXN0ZXIgbm9kZS4nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgKG1hc3Rlck5vZGUgYXMgTWFzdGVyTm9kZSkucHJvcGVydGllcyA9IHByb3BlcnRpZXM7XHJcblxyXG4gICAgICAgIHRoaXMuYWxsTm9kZXMuZm9yRWFjaChub2RlcyA9PiB7XHJcbiAgICAgICAgICAgIG5vZGVzLmZvckVhY2gobm9kZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBub2RlLmJlZm9yZUdlbnJlYXRlQ29kZSgpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGxldCBjb2RlID0gbWFzdGVyTm9kZS5nZW5lcmF0ZUNvZGUoKTtcclxuICAgICAgICByZXR1cm4gY29kZTtcclxuICAgIH1cclxufVxyXG4iXX0=